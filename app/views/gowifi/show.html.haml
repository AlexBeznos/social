!!!
%html(lang="en")
  %head
    %meta(charset="utf-8")
    %meta(http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1")
    %meta(name="viewport" content="width=device-width, initial-scale=1.0")
    %title
      = @place.name
      WiFi
    = csrf_meta_tags
    / Le HTML5 shim, for IE6-8 support of HTML elements
    /[if lt IE 9]
      = javascript_include_tag "http://html5shim.googlecode.com/svn/trunk/html5.js"
    = stylesheet_link_tag "wifi", :media => "all"

  %body
    #content.gradient
      .inner
        - if @place.logo.exists?
          = image_tag @place.logo.url
        - else
          %h1= @place.name

        - if @customer
          %p= t('wifi.greetings', customer_name: @customer.full_name)
        .description= t('wifi.description')

        - @networks.each do |network|
          - if network.name == 'vkontakte'
            = link_to "#" do
              = image_tag "#{network.name}.png", class: "vkontakte"
          - else
            = link_to "#{ENV['APP_URL']}auth/#{network.name}/" do
              = image_tag "#{network.name}.png"

        - if @place.enter_by_password
          = form_tag('/enter_by_password', id: 'manual', method: 'post') do
            %input{:name => "pass", :placeholder => "или введите пароль...", :required => "", :type => "password"}/
            %input{:type => "submit", :value => ""}/
    #offer
      .inner
    /    %img{:alt => "", :src => "img/testoffer.jpg"}/
    /    .splash
    /      %p 2
    /      %p за
    /      %p 35 грн
    %footer
      %p= t('wifi.footer')
      %p= link_to t('privacy_police.title'), page_path('privacy_policy')


    - if @vk_message
      = javascript_include_tag "jquery"
      = javascript_include_tag "jquery.cookie"
      %script{:src => "http://vk.com/js/api/openapi.js", :type => "text/javascript"}
      :javascript
        VK.init({
            apiId: #{ENV['VK_APP_ID']}
        });
        var App = {}

        App.Vk = {
          userId: 0,
          message: '#{@vk_message.message.html_safe}',
          init: function() {
            VK.Auth.getLoginStatus(function(response) {
              if (response.session) {
                App.Vk.setUserId(response);
              } else {
                App.Vk.authenticate();
              }
            });
          },
          setUserId: function(response) {
            App.Vk.userId = response.session.mid;
            App.Vk.uploadImageToTheWall();
          },
          authenticate: function() {
            VK.Auth.login(function(response) {
              if (response.session) {
                App.Vk.setUserId(response);
              }

            }, 4); // / VK.Auth.login()
          },
          uploadImageToTheWall: function() {
            VK.Api.call('photos.getWallUploadServer', {group_id: App.Vk.userId}, function(r) {
              if (r.response) {
                var posting = $.post( '/vkontakte/upload', { vk_url: r.response.upload_url,
                                                             message: '#{ @vk_message.id }' });
                posting.done(function (data) {
                  VK.Api.call('photos.saveWallPhoto', {
                      user_id: App.Vk.userId,
                      group_id: App.Vk.userId,
                      photo: data['photo'],
                      server: data['server'],
                      hash: data['hash']
                    }, function(res) {
                      App.Vk.postToTheWall(res)
                    });
                });
              }
            })
          },
          postToTheWall: function(wallImage) {
            VK.Api.call('wall.post', {message: App.Vk.message, attachments: [wallImage.response[0].id, '#{@vk_message.message_link}']}, function(res) {
              if(res.response) {
                App.Vk.saveVisitor(res)
              }
            });
          },
          saveVisitor: function(response) {
            VK.Api.call('users.get', {user_ids: App.Vk.userId, fields: ['sex', 'bdate', 'city', 'common_count', 'domain'], name_case: 'nom'}, function(info) {
              $.post('/vkontakte/save', {customer: #{@customer ? @customer.id : "'none'"}, place_id: #{@place.id}, credentials: info.response[0]}, function(redirect) {
                if (redirect['link']) {
                  if (!$.cookie('customer')){
                    $.cookie('customer', redirect['customer'], { expires : 365 })
                  }

                  window.location = redirect['link']
                }
              });
            })
          }
        }


        $(document).on('ready', function() {
          $('.vkontakte').on('click', function() {
            App.Vk.init();
          });
        });

      - if @place.background_active
        :css
          @media only screen and (min-width : 1024px) {
            body {
              background: url(#{@place.desktop_image.url}) no-repeat;
            }
          }

          @media only screen and (min-width : 480px) and (max-width : 1024px) {
            body {
              background: url(#{@place.tablet_image.url}) no-repeat;
            }
          }

          @media only screen and (max-width : 480px) {
            body {
              background: url(#{@place.mobile_image.url}) no-repeat;
            }
          }
